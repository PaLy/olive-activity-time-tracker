import{d as p,g as H,a as O,j as t,u as D,c as C,r as y,B as u,I as j,b as V,e as f,L as Y,M as _,f as $,o as S,h as W,i as M,k as N,l as G,P as K,O as q,C as Q}from"./index-DE89N4ny.js";import{u as F,B as E,T as g,a as U}from"./Slide-ChgE62Io.js";import{u as b,d as X,a as J}from"./hooks-DnkQxRD8.js";import{D as Z,a as tt,b as et}from"./DialogContent-CVj3DIFa.js";import{D as nt}from"./DialogTitle-D2VEJss7.js";import{A as at,S as st,L as it,a as rt,b as ot,c as ct,R as lt,F as dt,d as ht}from"./FormControlLabel-DhnUq2Wx.js";import{F as w,a as mt}from"./FullScreenModal-C5C2mCnX.js";import{T as vt,L as ut}from"./listItemTextClasses-Cu445j8s.js";async function xt(n){const{activity:e,ancestors:a,descendants:c,intervals:l}=await p.transaction("r",p.activities,p.intervals,async()=>{const s=await p.activities.get(n);if(!s)throw new Error(`Activity with ID ${n} does not exist.`);const[i,h]=await Promise.all([H(s),O(s)]),m=[s.id,...h.map(v=>v.id)],x=await p.intervals.where("activityId").anyOf(m).toArray();return{activity:s,ancestors:i,descendants:h,intervals:x}}),o=new Map;o.set(e.id,e),a.concat(c).forEach(s=>{o.set(s.id,s)});const d=[],r=new Map;return l.forEach(s=>{const i=new Date(s.start).setHours(0,0,0,0);r.has(i)||(r.set(i,[]),d.push({dayStart:i,intervals:r.get(i)})),r.get(i)?.push(s)}),d.sort((s,i)=>i.dayStart-s.dayStart),d.forEach(s=>{s.intervals.sort((i,h)=>h.start-i.start)}),{id:n,activities:o,intervalsByDay:d}}const yt=()=>{const n=b(e=>e.isDeleteIntervalConfirmationOpen());return t.jsx(Z,{open:n,children:t.jsx(pt,{})})},pt=()=>{const n=b(r=>r.closeDeleteIntervalConfirmation),e=b(r=>r.deleteIntervalConfirmationData),{intervalId:a}=e??{},c=D(r=>r.openSuccess),l=D(r=>r.openError),o=F(),d=()=>{n(),o(-1),X(a).then(()=>{c("Interval successfully deleted")}).catch(()=>l("Failed to delete interval"))};return t.jsxs(t.Fragment,{children:[t.jsx(nt,{children:"Are you sure you want to delete the interval?"}),t.jsx(tt,{children:"You cannot undo this action."}),t.jsxs(et,{children:[t.jsx(E,{autoFocus:!0,"aria-label":"no",onClick:n,children:"No"}),t.jsx(E,{"aria-label":"yes",onClick:d,children:"Yes"})]})]})},k=C(t.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75z"})),ft=C(t.jsx("path",{d:"M9 16.17 4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"})),gt=C(t.jsx("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"})),L=(n,e,a=-1)=>y.useMemo(()=>{const c=e.get(n);if(!c)return"";const l=[];let o=c;for(;o&&o.id!==a;)l.unshift(o.name),o=e.get(o.parentId);return l.join(at)},[e,n,a]),jt=n=>{const{activityId:e,activities:a,editMode:c,name:l,validationError:o,onEditStart:d,onNameChange:r,onSave:s,onCancel:i}=n,h=L(e,a),m=v=>{const I=v.target.value;r(I)},x=v=>{v.key==="Enter"?s():v.key==="Escape"&&i()};return t.jsxs(u,{sx:{display:"flex",alignItems:"flex-start",pl:2,pr:2,mb:1},children:[c?t.jsx(u,{sx:{flexGrow:1,mr:1},children:t.jsx(vt,{label:"Name",value:l,onChange:m,onKeyDown:x,variant:"outlined",size:"small",placeholder:"Activity name",sx:{width:"100%"},autoFocus:!0,error:!!o,helperText:o})}):t.jsx(g,{variant:"h6",sx:{flexGrow:1},children:h}),t.jsx(u,{sx:{display:"flex",alignItems:"flex-start",mt:c?.5:0},children:c?t.jsxs(t.Fragment,{children:[t.jsx(j,{"aria-label":"save activity",onClick:s,children:t.jsx(ft,{})}),t.jsx(j,{"aria-label":"cancel edit",onClick:i,children:t.jsx(gt,{})})]}):t.jsx(j,{"aria-label":"edit activity",onClick:d,children:t.jsx(k,{})})})]})},St=n=>{const{activityDetails:e,editingState:a,onEditStart:c,onNameChange:l,onSave:o,onCancel:d}=n,{id:r,activities:s}=e,i=F(),h=()=>{i("settings")};return t.jsxs(u,{sx:{pt:1,pb:1},children:[t.jsxs(u,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[t.jsx(w,{headline:"Activity Details"}),t.jsx(j,{"aria-label":"Activity settings",onClick:h,sx:{mr:2},children:t.jsx(st,{})})]}),t.jsx(jt,{activityId:r,activities:s,editMode:a.editMode,name:a.name,validationError:a.validationError,onEditStart:c,onNameChange:l,onSave:o,onCancel:d}),t.jsx(g,{variant:"h6",sx:{pl:2,pr:2},children:"Intervals"})]})},T=n=>{const{dayStart:e,stickyItemVisible:a}=n;return t.jsx(it,{style:{opacity:a?0:1},children:V(f(e))})},R="HH:mm:ss",It=n=>{const{start:e,end:a}=n;return a===_?"now":f(e).isSame(f(a),"day")?f(a).format(R):f(a).format("ddd, MMM D, YYYY HH:mm")},P=n=>{const{activityId:e,interval:a,activities:c}=n,{start:l,activityId:o}=a,d=J(a.start,a.end,!1),r=L(o,c,e),s=e!==o?` (${r})`:"",i=f(l).format(R),h=It(a);return t.jsxs(ut,{dense:!0,children:[t.jsx(rt,{primary:t.jsxs(t.Fragment,{children:[i," â€” ",h,s]}),secondary:t.jsx(t.Fragment,{children:d})}),t.jsx(ot,{sx:{minWidth:"initial"},children:t.jsx(j,{"aria-label":"edit interval",component:Y,to:`interval/${a.id}`,children:t.jsx(k,{})})})]})},bt=(n,e,a,c,l,o,d)=>y.useMemo(()=>{const{intervalsByDay:r,activities:s}=n;let i=1;return[{RowComponent:St,rowProps:{activityDetails:n,editingState:a,onEditStart:c,onNameChange:l,onSave:o,onCancel:d},rowData:{size:104}},...r.flatMap(h=>{const{dayStart:m,intervals:x}=h,I={RowComponent:T,rowProps:{dayStart:m,stickyItemVisible:e===i},rowData:{size:48}},z=x.map(B=>({RowComponent:P,rowProps:{interval:B,activities:s,activityId:n.id},rowData:{size:60.03125}})),A=[I,...z];return i+=A.length,A})]},[n,e,a,c,l,o,d]),wt=n=>{const{interval:e}=n;return t.jsx(t.Fragment,{children:e&&t.jsx(T,{dayStart:e.start})})},Ct=n=>{const{children:e,ref:a,...c}=n,l=y.useRef(void 0);return y.useImperativeHandle(a,()=>({setTopInterval:o=>{l.current=o}})),t.jsxs(u,{...c,sx:{mb:1},children:[t.jsx(wt,{interval:l.current}),e]})},At=n=>{const{activityDetails:e,editingState:a,onEditStart:c,onNameChange:l,onSave:o,onCancel:d}=n,[r,s]=y.useState(0),i=bt(e,r,a,c,l,o,d),h=y.useMemo(()=>{if(r>0)return i.slice(r).find(m=>m.RowComponent===P)?.rowProps.interval},[i,r]);return t.jsx(ct,{children:({width:m,height:x})=>t.jsx(lt,{height:x,width:m,itemData:i,innerElementType:Ct,innerRef:v=>v?.setTopInterval(h),onItemsRendered:({visibleStartIndex:v})=>{s(v)}})})},Dt=n=>{const[e,a]=y.useState({editMode:!1,name:"",siblingNames:new Set,validationError:""}),c=(s,i)=>s.trim()===""?"Activity name cannot be empty":i.has(s.trim().toLowerCase())?"An activity with this name already exists in the same parent":"";return{editingState:e,handleEditStart:async s=>{if(s)try{const i=await W(n),h=new Set(i.map(x=>x.name.toLowerCase())),m=s.activities.get(n);a({editMode:!0,name:m?.name||"",siblingNames:h,validationError:""})}catch(i){console.error(i),S("Failed to load activity data")}},handleNameChange:s=>{const i=c(s,e.siblingNames);a(h=>({...h,name:s,validationError:i}))},handleSave:()=>{const s=e.name.trim(),i=c(s,e.siblingNames);if(i){a(h=>({...h,validationError:i}));return}$(n,s).then(()=>{a({editMode:!1,name:"",siblingNames:new Set,validationError:""})}).catch(h=>{console.error(h),S("Failed to save activity name")})},handleCancel:()=>{a({editMode:!1,name:"",siblingNames:new Set,validationError:""})}}},Et=()=>{const{pathname:n}=U();return t.jsx(mt,{open:n.endsWith("/settings"),children:t.jsx(Mt,{})})},Mt=()=>{const n=M(),e=parseInt(n.activityID??""),[a,c]=y.useState(!1),l=N(()=>p.activities.get(e),[e]),o=async d=>{if(l){c(!0);try{await p.activities.update(e,{notificationsEnabled:d?1:0}),G("Notification settings updated")}catch(r){console.error("Failed to update notification settings:",r),S("Failed to update notification settings")}finally{c(!1)}}};return l?t.jsxs(t.Fragment,{children:[t.jsx(w,{headline:"Activity Settings"}),t.jsxs(u,{sx:{p:2},children:[t.jsx(g,{variant:"h6",sx:{mb:3},children:l.name}),t.jsxs(u,{sx:{mb:3},children:[t.jsx(g,{variant:"subtitle1",sx:{mb:2},children:"Notifications"}),t.jsx(dt,{control:t.jsx(ht,{checked:!!l.notificationsEnabled,onChange:d=>o(d.target.checked),disabled:a,"aria-label":"Show notifications when this activity is in progress"}),label:"Show notifications when this activity is in progress"}),t.jsx(g,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"When enabled, you'll receive notifications while this activity is active."})]})]})]}):t.jsxs(t.Fragment,{children:[t.jsx(w,{headline:"Activity Settings"}),t.jsx(u,{sx:{p:2},children:t.jsx(g,{children:"Activity not found"})})]})},Ht=()=>{const n=M(),e=parseInt(n.activityID??""),{editingState:a,handleEditStart:c,handleNameChange:l,handleSave:o,handleCancel:d}=Dt(e),r=N(()=>xt(e).catch(s=>{console.error(s),S("Activity not found")}),[e]);return t.jsxs(t.Fragment,{children:[t.jsx(K,{square:!0,sx:{height:"100%"},children:r?t.jsx(At,{activityDetails:r,editingState:a,onEditStart:()=>c(r),onNameChange:l,onSave:o,onCancel:d}):t.jsx(Nt,{})}),t.jsx(q,{}),t.jsx(yt,{}),t.jsx(Et,{})]})};function Nt(){return t.jsx(u,{sx:{display:"flex",height:"100%",justifyContent:"center",alignItems:"center"},children:t.jsx(Q,{})})}export{Ht as ActivityDetailsPage};
//# sourceMappingURL=ActivityDetailsPage-CgPAelxQ.js.map
